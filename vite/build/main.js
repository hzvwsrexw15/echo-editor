"use strict";const{app:d,BrowserWindow:y,clipboard:g,screen:f,nativeImage:$}=require("electron"),c=require("path"),r=require("fs"),w=require("os"),{ipcMain:o}=require("electron/main"),p=require("form-data"),h=require("axios"),m=c.join(d.getPath("home"),"echoeditor"),l=c.join(m,"data");console.log("Platform:",w.platform());console.log("Architecture:",w.arch());const v=$.createFromPath(c.join(__dirname,"images","icon.png"));d.dock.setIcon(v);if(!r.existsSync(m))try{r.mkdirSync(m)}catch(s){console.log("创建folder文件夹失败: ",s)}if(!r.existsSync(l))try{r.mkdirSync(l)}catch(s){console.log("创建folder文件夹失败: ",s)}function S(s,...n){const[e,a]=n;if(!e||!a)return{status:!1,message:"文件夹名称或内容为空"};if(r.existsSync(l))try{r.writeFileSync(`${l}/${e}`,a,"utf-8")}catch(t){return{status:!1,message:`写入文件 ${e} 失败:${t}`}}else try{r.mkdirSync(l)}catch(t){return console.log(t),{status:!1,message:`创建文件夹 ${l} 失败:${t}`}}return{status:!0,message:`写入文件 ${e} 成功！`}}function _(s,...n){const[e]=n;try{const a=r.readFileSync(`${l}/${e}`,"utf8");return{status:!0,message:`读取文件 ${e} 成功！`,content:a}}catch(a){return{status:!1,message:`读取文件 ${e} 失败:${a}`}}}function j(s,...n){const[e]=n;try{return r.unlinkSync(`${l}/${e}`),{status:!0,message:`删除文件 ${e} 成功！`}}catch(a){return{status:!1,message:`删除文件 ${e} 失败:${a}`}}}require("electron-squirrel-startup")&&d.quit();const F=()=>{const s=new y({width:Math.floor(f.getPrimaryDisplay().size.width*.8),height:Math.floor(f.getPrimaryDisplay().workAreaSize.height*.8),webPreferences:{preload:c.join(__dirname,"preload.js")},titleBarStyle:"hidden",title:"Echo Editor",icon:c.join(__dirname,"images","icon.png")});o.removeHandler("storage:insertFile"),o.removeHandler("storage:readFileInfo"),o.removeHandler("storage:removeFile"),o.removeHandler("storage:uploadFile"),o.removeHandler("image:paste"),o.handle("storage:insertFile",S),o.handle("storage:readFileInfo",_),o.handle("storage:removeFile",j),o.handle("storage:uploadFile",async(n,...e)=>{const[a]=e,t=new p;t.append("size",a.size),t.append("filename",a.name),t.append("file",r.createReadStream(a.path));const i=await h.post("https://api.yunzhu.info/oss/editorUploadForm",t,{headers:t.getHeaders()});return i.status===200&&i.data&&i.data.errno===0?i.data.data.url:""}),o.handle("image:paste",async()=>{const n=g.availableFormats("clipboard");if(n.includes("image/png")||n.includes("image/jpeg")){const e=g.readImage("clipboard").toDataURL().split(";base64,").pop(),a=c.join(__dirname,n.includes("image/png")?"image.png":"image.jpeg");try{r.writeFileSync(a,e,{encoding:"base64"})}catch{console.error("Error add file:",err)}const t=new p;t.append("filename","image.png"),t.append("file",r.createReadStream(a));const i=await h.post("https://api.yunzhu.info/oss/editorUploadForm",t,{headers:t.getHeaders()});try{r.unlinkSync(a)}catch(u){console.error("Error deleting file:",u)}return i.status===200&&i.data&&i.data.errno===0?i.data.data.url:""}return""}),s.loadFile(c.join(__dirname,"../renderer/main_window/index.html"))};d.on("ready",F);d.on("window-all-closed",()=>{process.platform!=="darwin"&&d.quit()});d.on("activate",()=>{y.getAllWindows().length===0&&F()});
