"use strict";const{app:d,BrowserWindow:S,clipboard:g,screen:y,nativeImage:v,shell:P}=require("electron"),c=require("path"),a=require("fs"),F=require("os"),{ipcMain:i}=require("electron/main"),b=require("form-data"),m=require("axios"),j=require("dayjs"),u=c.join(d.getPath("home"),"echoeditor"),l=c.join(u,"data"),h=c.join(u,"backup");console.log("Platform:",F.platform());console.log("Architecture:",F.arch());const k=v.createFromPath(c.join(__dirname,"images","icon.png"));d.dock.setIcon(k);if(!a.existsSync(u))try{a.mkdirSync(u)}catch(o){console.log("创建folder文件夹失败: ",o)}if(!a.existsSync(l))try{a.mkdirSync(l)}catch(o){console.log("创建data文件夹失败: ",o)}if(!a.existsSync(h))try{a.mkdirSync(h)}catch(o){console.log("创建backup文件夹失败: ",o)}function f(o){const r=`${l}/${o}`;try{if(!a.existsSync(r)){const e=`${d.getAppPath()}/src/template/${o}`,t=a.readFileSync(e,"utf8");a.writeFileSync(r,t,"utf-8")}}catch(e){console.log(e)}}f("article_b7d93428-a98c-4e70-9d6d-4924469d72c9.echo");f("article_1525b4f2-fce5-4b20-aade-9cd2912acbe2.echo");f("article_fa3ea50e-46ca-4ac4-a5b4-5d937ff1f002.echo");f("article_f118bd97-0a7d-4bef-878a-76a57d9ed63a.echo");f("article_0fbdbb2f-1d55-495d-8eef-6fe1763072fe.echo");f("article_ce95c91c-da94-415a-86ee-3c27655c9a04.echo");f("article_f2ea4df8-c9b8-40e7-bb6e-b01d362bd570.echo");function w(o,r){if(!a.existsSync(r))a.mkdirSync(r);else return!0;a.readdirSync(o).forEach(function(t){const n=c.join(o,t),s=c.join(r,t);a.statSync(n).isDirectory()?w(n,s):a.copyFileSync(n,s)})}function $(){w(l,c.join(h,j().format("YYYY-MM-DD")))}$();function q(o,...r){const[e,t]=r;if(!e||!t)return{status:!1,message:"文件夹名称或内容为空"};if(a.existsSync(l))try{a.writeFileSync(`${l}/${e}`,t,"utf-8")}catch(n){return{status:!1,message:`写入文件 ${e} 失败:${n}`}}else try{a.mkdirSync(l)}catch(n){return console.log(n),{status:!1,message:`创建文件夹 ${l} 失败:${n}`}}return{status:!0,message:`写入文件 ${e} 成功！`}}function D(o,...r){const[e]=r;try{const t=a.readFileSync(`${l}/${e}`,"utf8");return{status:!0,message:`读取文件 ${e} 成功！`,content:t}}catch(t){return{status:!1,message:`读取文件 ${e} 失败:${t}`}}}function x(o,...r){const[e]=r;try{return a.unlinkSync(`${l}/${e}`),{status:!0,message:`删除文件 ${e} 成功！`}}catch(t){return{status:!1,message:`删除文件 ${e} 失败:${t}`}}}require("electron-squirrel-startup")&&d.quit();const _=()=>{const o=new S({width:Math.floor(y.getPrimaryDisplay().size.width*.8),height:Math.floor(y.getPrimaryDisplay().workAreaSize.height*.8),webPreferences:{preload:c.join(__dirname,"preload.js")},titleBarStyle:"hidden",trafficLightPosition:{x:10,y:10},title:"Echo Editor",icon:c.join(__dirname,"images","icon.png")});i.removeHandler("storage:insertFile"),i.removeHandler("storage:readFileInfo"),i.removeHandler("storage:removeFile"),i.removeHandler("storage:uploadFile"),i.removeHandler("image:paste"),i.removeHandler("storage:request"),i.removeHandler("open:link"),i.handle("storage:insertFile",q),i.handle("storage:readFileInfo",D),i.handle("storage:removeFile",x),i.handle("storage:uploadFile",async(r,...e)=>{const[t]=e,n=new b;n.append("size",t.size),n.append("filename",t.name),n.append("file",a.createReadStream(t.path));const s=await m.post("https://api.yunzhu.info/oss/editorUploadForm",n,{headers:n.getHeaders()});return s.status===200&&s.data&&s.data.errno===0?s.data.data.url:""}),i.handle("storage:request",async(r,e)=>{const t=await m(e);return{data:t.data,status:t.status}}),i.handle("image:paste",async()=>{const r=g.availableFormats("clipboard");if(r.includes("image/png")||r.includes("image/jpeg")){const e=g.readImage("clipboard").toDataURL().split(";base64,").pop(),t=c.join(__dirname,r.includes("image/png")?"image.png":"image.jpeg");try{a.writeFileSync(t,e,{encoding:"base64"})}catch{console.error("Error add file:",err)}const n=new b;n.append("filename","image.png"),n.append("file",a.createReadStream(t));const s=await m.post("https://api.yunzhu.info/oss/editorUploadForm",n,{headers:n.getHeaders()});try{a.unlinkSync(t)}catch(p){console.error("Error deleting file:",p)}return s.status===200&&s.data&&s.data.errno===0?s.data.data.url:""}return""}),i.handle("open:link",async(r,e)=>(e&&P.openExternal(e),!0)),o.loadFile(c.join(__dirname,"../renderer/main_window/index.html"))};d.on("ready",_);d.on("window-all-closed",()=>{process.platform!=="darwin"&&d.quit()});d.on("activate",()=>{S.getAllWindows().length===0&&_(),$()});
